# Архитектура проекта FlappyCoin

## Общее описание
FlappyCoin - это многопользовательская игра в стиле FlappyBird для Telegram Mini Apps с криптовалютной тематикой. Игроки управляют монетой, которая летит через трубы, соревнуясь друг с другом в реальном времени.

## Технический стек
- **Сервер**: Node.js, Express.js, Socket.IO
- **Клиент**: HTML, CSS, JavaScript, Canvas API
- **Архитектура клиента**: Single Page Application (SPA)
- **Коммуникация**: WebSocket через Socket.IO
- **Хранение данных**: JSON-файлы (telegramUsers.json)
- **Логирование**: Клиентское и серверное логирование
- **Контейнеризация**: Docker, Docker Compose
- **SSL**: Let's Encrypt через certbot

## Структура проекта
```
FlappyCoin/
├── client/                # Клиентская часть (SPA)
│   ├── index.html         # Единая HTML-страница приложения
│   ├── app.js             # Основной контроллер приложения
│   ├── telegram.js        # Функции для работы с Telegram WebApp API
│   ├── logger.js          # Модуль клиентского логирования
│   ├── views/             # Компоненты для различных экранов
│   │   ├── mainMenu.js    # Компонент главного меню
│   │   └── roomView.js    # Компонент игровой комнаты
│   ├── services/          # Сервисы приложения
│   │   └── socketService.js # Менеджер WebSocket соединения
│   ├── style/             # CSS-стили
│   │   ├── app.css        # Общие стили приложения
│   │   ├── mainMenu.css   # Стили главного меню
│   │   └── room.css       # Стили комнаты
│   └── assets/            # Графические ресурсы
│       ├── bitcoin.png    # Спрайт монеты Bitcoin
│       ├── main-menu.png  # Фоновое изображение для меню
│       ├── background-blur.jpg # Фоновое изображение для комнаты
│       └── default-avatar.png # Аватар по умолчанию
├── server/                # Серверная часть
│   ├── server.js          # Основной сервер (Express + Socket.IO)
│   ├── rooms.js           # Логика управления комнатами
│   └── telegramUsers.json # Хранение данных игроков
├── .env                   # Переменные окружения
├── Dockerfile             # Конфигурация контейнера
├── docker-compose.yml     # Конфигурация Docker Compose
└── package.json           # Зависимости и скрипты проекта
```

## Компоненты и их функции

### Клиентская часть (SPA)

#### 1. Основной контроллер (app.js)
- Инициализация приложения
- Переключение между экранами без перезагрузки страницы
- Хранение глобального состояния приложения
- Управление навигацией (URL-параметры, история)
- Управление вызовами Telegram WebApp API

#### 2. Сервисы приложения
- **socketService.js** - единый менеджер WebSocket-соединения:
  - Поддерживает постоянное соединение на протяжении всего приложения
  - Централизованно регистрирует и управляет обработчиками событий
  - Обеспечивает автоматическое переподключение при потере связи

#### 3. Компоненты представлений
- **mainMenu.js** - компонент главного меню:
  - Отображение данных пользователя из Telegram
  - Анимированная монета в центре экрана
  - Кнопка для создания комнаты
  - Отрисовка и управление элементами интерфейса главного меню

- **roomView.js** - компонент комнаты ожидания:
  - Отображение списка игроков в комнате
  - Индикация статуса готовности игроков
  - Обратный отсчет перед началом игры
  - Обработка ошибок, связанных с комнатой

### Архитектура SPA

Приложение построено на основе Single Page Application (SPA) архитектуры с следующими ключевыми характеристиками:

1. **Единая точка входа** - один HTML-файл (index.html) содержит всё приложение
2. **Компонентный подход** - каждый экран реализован как отдельный компонент с собственными:
   - HTML-шаблоном
   - Логикой инициализации и отрисовки
   - Обработчиками событий
   - Функцией очистки ресурсов при удалении с экрана

3. **Модульные сервисы**:
   - Телеграм-сервис для работы с Telegram WebApp API
   - Сокет-сервис для работы с WebSocket
   - Сервис логирования для отладки и трекинга ошибок

4. **Жизненный цикл экрана**:
   - Инициализация (init) - загрузка данных и отрисовка шаблона
   - Рендеринг (render) - обновление DOM при изменении данных
   - Очистка (cleanup) - освобождение ресурсов при смене экрана

5. **Управление состоянием**:
   - Глобальное состояние в app.js (текущий экран, данные пользователя)
   - Локальное состояние в компонентах (данные, специфичные для экрана)
   - Сохранение критичных данных в localStorage для восстановления сессии

6. **Навигация**:
   - Управление через параметры URL (без перезагрузки страницы)
   - Обновление URL при переходе между экранами
   - История переходов для возврата на предыдущий экран

### Преимущества SPA для Telegram Mini App
1. **Непрерывное WebSocket-соединение** - сокет не разрывается при навигации
2. **Сохранение данных и состояния** - нет необходимости повторно загружать данные при возвращении на экран
3. **Плавные переходы** - быстрое переключение между экранами без мерцания
4. **Оптимизация работы с Telegram API** - однократная инициализация и сохранение состояния
5. **Улучшенное пользовательское взаимодействие** - нет задержек на загрузку HTML страниц

### Серверная часть

#### 1. Основной сервер (server.js)
- Настройка Express и Socket.IO
- Обработка HTTP и WebSocket-запросов
- Статичная раздача клиентских файлов
- API для получения данных о комнатах и пользователях
- Обработка подключений и отключений пользователей
- Сохранение сессий пользователей

#### 2. Модуль управления комнатами (rooms.js)
- Управление жизненным циклом комнат
- Добавление/удаление игроков
- Управление статусами готовности
- Хранение данных о счете игроков
- Безопасные методы доступа к комнатам с проверками

### Взаимодействие компонентов
1. Клиент подключается через WebSocket, отправляет данные из Telegram
2. Сервер сохраняет данные пользователя в telegramUsers.json
3. Клиент может создать или присоединиться к комнате
4. При навигации между страницами сохраняется состояние комнаты и соединения
5. В комнате игроки отмечают готовность, запускается обратный отсчет
6. В игре клиенты обмениваются данными о позициях через WebSocket
7. При отключении игрока сервер обрабатывает его статус в зависимости от контекста

## WebSocket-события
В данном разделе описаны WebSocket-события в порядке их появления в процессе взаимодействия пользователя с приложением. Для каждого события указано, кто его инициирует, какой ожидается ответ и откуда происходит вызов.

### Авторизация и подключение

1. `connect` - **системное событие Socket.IO**
   - **Инициатор:** Socket.IO клиент
   - **Вызывается из:** services/socketService.js при создании соединения
   - **Обработчик:** На сервере в server.js
   - **Ответ:** Нет прямого ответа, но после подключения сервер готов принимать другие события

2. `join` - **авторизация пользователя**
   - **Инициатор:** Клиент (инициируется сразу после connect)
   - **Вызывается из:** services/socketService.js
   - **Передаваемые данные:** Объект с данными пользователя из Telegram (initData)
   - **Обработчик:** server.js
   - **Ответ:** События `joined` или `error`

3. `joined` - **подтверждение авторизации**
   - **Инициатор:** Сервер (как ответ на join)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с данными пользователя и статусом успеха
   - **Обработчик:** services/socketService.js, передается в компоненты через события
   - **Что происходит:** Клиент подтверждает авторизацию, сохраняет данные пользователя

### Управление комнатами

4. `createRoom` - **создание игровой комнаты**
   - **Инициатор:** Клиент (при нажатии на кнопку "Играть")
   - **Вызывается из:** views/mainMenu.js
   - **Передаваемые данные:** Объект с данными пользователя и настройками комнаты
   - **Обработчик:** server.js, server/rooms.js
   - **Ответ:** События `roomCreated` или `error`

5. `roomCreated` - **уведомление о создании комнаты**
   - **Инициатор:** Сервер (как ответ на createRoom)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с ID созданной комнаты и списком игроков
   - **Обработчик:** views/mainMenu.js, передается в компоненты через события
   - **Что происходит:** Клиент сохраняет ID комнаты и перенаправляется на страницу комнаты

6. `joinRoom` - **присоединение к комнате**
   - **Инициатор:** Клиент (при переходе на страницу комнаты с известным ID)
   - **Вызывается из:** views/roomView.js
   - **Передаваемые данные:** ID комнаты и данные пользователя
   - **Обработчик:** server.js, server/rooms.js
   - **Ответ:** События `roomJoined` или `error`

7. `roomJoined` - **подтверждение присоединения к комнате**
   - **Инициатор:** Сервер (как ответ на joinRoom)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с данными комнаты и списком игроков
   - **Обработчик:** views/roomView.js, передается в компоненты через события
   - **Что происходит:** Клиент обновляет UI комнаты, отображая всех игроков

8. `playerJoined` - **уведомление о новом игроке в комнате**
   - **Инициатор:** Сервер (при успешном присоединении игрока к комнате)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с данными нового игрока и обновленным списком игроков
   - **Обработчик:** views/roomView.js для всех клиентов в комнате
   - **Что происходит:** Все клиенты в комнате обновляют UI, добавляя нового игрока

9. `toggleReady` - **изменение статуса готовности**
   - **Инициатор:** Клиент (при нажатии на статус готовности)
   - **Вызывается из:** views/roomView.js
   - **Передаваемые данные:** ID комнаты и ID пользователя
   - **Обработчик:** server.js, server/rooms.js
   - **Ответ:** События `playerStatusChanged` для всех игроков в комнате

10. `playerStatusChanged` - **уведомление об изменении статуса игрока**
    - **Инициатор:** Сервер (после получения toggleReady)
    - **Вызывается из:** server.js
    - **Передаваемые данные:** Объект с ID игрока и новым статусом готовности
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Все клиенты обновляют UI, показывая новый статус игрока

11. `allPlayersReady` - **уведомление о готовности всех игроков**
    - **Инициатор:** Сервер (когда все игроки в комнате получили статус "готов")
    - **Вызывается из:** server.js
    - **Передаваемые данные:** Объект с ID комнаты и временем до старта игры
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Все клиенты показывают обратный отсчет до начала игры

12. `startGame` - **начало игры**
    - **Инициатор:** Сервер (когда истечет время обратного отсчета)
    - **Вызывается из:** server.js
    - **Передаваемые данные:** Объект с ID комнаты и стартовыми параметрами игры
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Все клиенты переходят на страницу игры и начинается геймплей

### Обработка ошибок и отключение

13. `roomError` - **ошибки, связанные с комнатами**
    - **Инициатор:** Сервер (при возникновении ошибок в операциях с комнатами)
    - **Вызывается из:** server.js:150, server.js:211
    - **Передаваемые данные:** Объект с сообщением об ошибке
    - **Обработчик:** views/mainMenu.js:160, views/roomView.js:181
    - **Что происходит:** Клиент отображает сообщение об ошибке и возможно перенаправляет пользователя

14. `error` - **общие ошибки**
    - **Инициатор:** Сервер (при возникновении других ошибок)
    - **Вызывается из:** server.js:88, server.js:258
    - **Передаваемые данные:** Объект с сообщением об ошибке
    - **Обработчик:** views/mainMenu.js:154, views/roomView.js:173
    - **Что происходит:** Клиент отображает сообщение об ошибке

15. `disconnect` - **отключение пользователя**
    - **Инициатор:** Socket.IO клиент (при закрытии страницы, потере соединения)
    - **Вызывается из:** Системное событие Socket.IO
    - **Обработчик:** server.js:302
    - **Что происходит:** Сервер обрабатывает выход игрока из комнаты, обновляет списки и уведомляет других игроков

## Обработка ошибок
1. Клиентская сторона обрабатывает ошибки и выводит понятные для пользователя сообщения
2. Сервер логирует ошибки и отправляет клиентам структурированные сообщения
3. Реализована система восстановления соединения при разрыве связи
4. Восстановление данных пользователя из localStorage при проблемах с Telegram API

## Переход между страницами
1. Приложение состоит из трех основных страниц: главное меню, комната ожидания и игра
2. При переходе между страницами используется localStorage для сохранения данных
3. Реализована логика для предотвращения потери комнаты при переходе между страницами
4. При отключении пользователя сервер учитывает контекст и дает время на переподключение

## Развертывание
1. Проект запускается через Docker Compose
2. Файлы настраиваются через переменные окружения в .env
3. SSL-сертификаты получаются через certbot
4. Сервер поддерживает как HTTP, так и HTTPS подключения 