# Архитектура проекта FlappyCoin

## Общее описание
FlappyCoin - это многопользовательская игра в стиле FlappyBird для Telegram Mini Apps с криптовалютной тематикой. Игроки управляют монетой, которая летит через трубы, соревнуясь друг с другом в реальном времени.

## Технический стек
- **Сервер**: Node.js, Express.js, Socket.IO
- **Клиент**: HTML, CSS, JavaScript, Canvas API
- **Архитектура клиента**: Single Page Application (SPA)
- **Коммуникация**: WebSocket через Socket.IO
- **Хранение данных**: JSON-файлы (telegramUsers.json)
- **Логирование**: Клиентское и серверное логирование
- **Контейнеризация**: Docker, Docker Compose
- **SSL**: Let's Encrypt через certbot
- **Интеграция**: Telegram Mini Apps API (WebApp)

## Структура проекта
```
FlappyCoin/
├── client/                # Клиентская часть (SPA)
│   ├── index.html         # Единая HTML-страница приложения
│   ├── app.js             # Основной контроллер приложения
│   ├── telegram.js        # Функции для работы с Telegram WebApp API
│   ├── logger.js          # Модуль клиентского логирования
│   ├── views/             # Компоненты для различных экранов
│   │   ├── mainMenu.js    # Компонент главного меню
│   │   ├── roomView.js    # Компонент игровой комнаты
│   │   └── gameView.js    # Компонент игрового процесса
│   ├── services/          # Сервисы приложения
│   │   └── socketService.js # Менеджер WebSocket соединения
│   ├── style/             # CSS-стили
│   │   ├── app.css        # Общие стили приложения
│   │   ├── mainMenu.css   # Стили главного меню
│   │   └── room.css       # Стили комнаты
│   └── assets/            # Графические ресурсы
│       ├── bitcoin.png    # Спрайт монеты Bitcoin
│       ├── ethereum.png   # Спрайт монеты Ethereum
│       ├── dogecoin.png   # Спрайт монеты Dogecoin
│       ├── main-menu.png  # Фоновое изображение для меню
│       ├── background-blur.jpg # Фоновое изображение для комнаты
│       └── default-avatar.png # Аватар по умолчанию
├── server/                # Серверная часть
│   ├── server.js          # Основной сервер (Express + Socket.IO)
│   ├── rooms.js           # Логика управления комнатами
│   ├── game.js            # Логика игрового процесса
│   ├── logger.js          # Система логирования на сервере
│   └── telegramUsers.json # Хранение данных игроков
├── .env                   # Переменные окружения
├── Dockerfile             # Конфигурация контейнера
├── docker-compose.yml     # Конфигурация Docker Compose
├── package.json           # Зависимости и скрипты проекта
├── struct.md              # Описание структуры проекта
└── architecture.md        # Документация архитектуры
```

## Компоненты и их функции

### Клиентская часть (SPA)

#### 1. Основной контроллер (app.js)
- Инициализация приложения
- Переключение между экранами без перезагрузки страницы
- Хранение глобального состояния приложения
- Управление навигацией (URL-параметры, история)
- Управление вызовами Telegram WebApp API
- Обработка системных событий Telegram (закрытие приложения, изменение вьюпорта)

#### 2. Сервисы приложения
- **socketService.js** - единый менеджер WebSocket-соединения:
  - Поддерживает постоянное соединение на протяжении всего приложения
  - Централизованно регистрирует и управляет обработчиками событий
  - Обеспечивает автоматическое переподключение при потере связи
  - Обрабатывает события подключения, отключения и ошибок

#### 3. Компоненты представлений
- **mainMenu.js** - компонент главного меню:
  - Отображение данных пользователя из Telegram
  - Анимированная монета в центре экрана
  - Кнопка для создания комнаты
  - Поле для ввода ID комнаты для присоединения
  - Отрисовка и управление элементами интерфейса главного меню

- **roomView.js** - компонент комнаты ожидания:
  - Отображение списка игроков в комнате
  - Индикация статуса готовности игроков
  - Переключение своего статуса готовности
  - Обратный отсчет перед началом игры
  - Отмена обратного отсчета при недостаточном количестве игроков
  - Обработка событий входа и выхода игроков
  - Обработка ошибок, связанных с комнатой

- **gameView.js** - компонент игрового процесса:
  - Рендеринг игрового поля с использованием Canvas API
  - Физика движения монет и препятствий
  - Обработка ввода пользователя (тап, клик)
  - Обновление позиций других игроков в реальном времени
  - Подсчет очков и определение победителей
  - Отображение финальных результатов игры

#### 4. Telegram-интеграция (telegram.js)
- Инициализация Telegram WebApp API
- Получение данных пользователя (initData)
- Настройка полноэкранного режима
- Обработка событий закрытия приложения
- Обработка изменений размера вьюпорта
- Проверка версии Telegram и доступности API
- Восстановление данных пользователя при отсутствии Telegram API

### Архитектура SPA

Приложение построено на основе Single Page Application (SPA) архитектуры с следующими ключевыми характеристиками:

1. **Единая точка входа** - один HTML-файл (index.html) содержит всё приложение
2. **Компонентный подход** - каждый экран реализован как отдельный компонент с собственными:
   - HTML-шаблоном
   - Логикой инициализации и отрисовки
   - Обработчиками событий
   - Функцией очистки ресурсов при удалении с экрана

3. **Модульные сервисы**:
   - Телеграм-сервис для работы с Telegram WebApp API
   - Сокет-сервис для работы с WebSocket
   - Сервис логирования для отладки и трекинга ошибок

4. **Жизненный цикл экрана**:
   - Инициализация (init) - загрузка данных и отрисовка шаблона
   - Рендеринг (render) - обновление DOM при изменении данных
   - Очистка (cleanup) - освобождение ресурсов при смене экрана

5. **Управление состоянием**:
   - Глобальное состояние в app.js (текущий экран, данные пользователя)
   - Локальное состояние в компонентах (данные, специфичные для экрана)
   - Сохранение критичных данных в localStorage для восстановления сессии

6. **Навигация**:
   - Управление через параметры URL (без перезагрузки страницы)
   - Обновление URL при переходе между экранами
   - История переходов для возврата на предыдущий экран

### Преимущества SPA для Telegram Mini App
1. **Непрерывное WebSocket-соединение** - сокет не разрывается при навигации
2. **Сохранение данных и состояния** - нет необходимости повторно загружать данные при возвращении на экран
3. **Плавные переходы** - быстрое переключение между экранами без мерцания
4. **Оптимизация работы с Telegram API** - однократная инициализация и сохранение состояния
5. **Улучшенное пользовательское взаимодействие** - нет задержек на загрузку HTML страниц

### Серверная часть

#### 1. Основной сервер (server.js)
- Настройка Express и Socket.IO
- Обработка HTTP и WebSocket-запросов
- Статичная раздача клиентских файлов
- API для получения данных о комнатах и пользователях
- Обработка подключений и отключений пользователей
- Сохранение сессий пользователей
- Логирование клиентских и серверных событий

#### 2. Модуль управления комнатами (rooms.js)
- Управление жизненным циклом комнат
- Добавление/удаление игроков
- Управление статусами готовности
- Запуск и отмена обратного отсчета
- Проверка минимального количества игроков
- Хранение данных о счете игроков
- Безопасные методы доступа к комнатам с проверками

#### 3. Модуль управления игрой (game.js)
- Генерация игрового окружения (трубы, препятствия)
- Физика движения объектов
- Обработка столкновений
- Синхронизация состояния игры между клиентами
- Подсчет и хранение результатов игры

### Взаимодействие компонентов
1. Клиент подключается через WebSocket, отправляет данные из Telegram
2. Сервер сохраняет данные пользователя в telegramUsers.json
3. Клиент может создать или присоединиться к комнате
4. При навигации между страницами сохраняется состояние комнаты и соединения
5. В комнате игроки отмечают готовность, запускается обратный отсчет
6. Отсчет прерывается, если количество игроков становится менее 2-х
7. В игре клиенты обмениваются данными о позициях через WebSocket
8. При отключении игрока сервер обрабатывает его статус в зависимости от контекста

## WebSocket-события
В данном разделе описаны WebSocket-события в порядке их появления в процессе взаимодействия пользователя с приложением. Для каждого события указано, кто его инициирует, какой ожидается ответ и откуда происходит вызов.

### Авторизация и подключение

1. `connect` - **системное событие Socket.IO**
   - **Инициатор:** Socket.IO клиент
   - **Вызывается из:** services/socketService.js при создании соединения
   - **Обработчик:** На сервере в server.js
   - **Ответ:** Нет прямого ответа, но после подключения сервер готов принимать другие события

2. `join` - **авторизация пользователя**
   - **Инициатор:** Клиент (инициируется сразу после connect)
   - **Вызывается из:** services/socketService.js
   - **Передаваемые данные:** Объект с данными пользователя из Telegram (initData)
   - **Обработчик:** server.js
   - **Ответ:** События `joined` или `error`

3. `joined` - **подтверждение авторизации**
   - **Инициатор:** Сервер (как ответ на join)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с данными пользователя и статусом успеха
   - **Обработчик:** services/socketService.js, передается в компоненты через события
   - **Что происходит:** Клиент подтверждает авторизацию, сохраняет данные пользователя

### Управление комнатами

4. `createRoom` - **создание игровой комнаты**
   - **Инициатор:** Клиент (при нажатии на кнопку "Играть")
   - **Вызывается из:** views/mainMenu.js
   - **Передаваемые данные:** Объект с данными пользователя и настройками комнаты
   - **Обработчик:** server.js, server/rooms.js
   - **Ответ:** События `roomCreated` или `error`

5. `roomCreated` - **уведомление о создании комнаты**
   - **Инициатор:** Сервер (как ответ на createRoom)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с ID созданной комнаты и списком игроков
   - **Обработчик:** views/mainMenu.js, передается в компоненты через события
   - **Что происходит:** Клиент сохраняет ID комнаты и перенаправляется на страницу комнаты

6. `joinRoom` - **присоединение к комнате**
   - **Инициатор:** Клиент (при переходе на страницу комнаты с известным ID)
   - **Вызывается из:** views/roomView.js
   - **Передаваемые данные:** ID комнаты и данные пользователя
   - **Обработчик:** server.js, server/rooms.js
   - **Ответ:** События `roomJoined` или `error`

7. `roomJoined` - **подтверждение присоединения к комнате**
   - **Инициатор:** Сервер (как ответ на joinRoom)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с данными комнаты и списком игроков
   - **Обработчик:** views/roomView.js, передается в компоненты через события
   - **Что происходит:** Клиент обновляет UI комнаты, отображая всех игроков

8. `playerJoined` - **уведомление о новом игроке в комнате**
   - **Инициатор:** Сервер (при успешном присоединении игрока к комнате)
   - **Вызывается из:** server.js
   - **Передаваемые данные:** Объект с данными нового игрока и обновленным списком игроков
   - **Обработчик:** views/roomView.js для всех клиентов в комнате
   - **Что происходит:** Все клиенты в комнате обновляют UI, добавляя нового игрока

9. `toggleReady` - **изменение статуса готовности**
   - **Инициатор:** Клиент (при нажатии на статус готовности)
   - **Вызывается из:** views/roomView.js
   - **Передаваемые данные:** ID комнаты, ID пользователя и флаг готовности
   - **Обработчик:** server.js, server/rooms.js
   - **Ответ:** События `playerStatusChanged` для всех игроков в комнате

10. `playerStatusChanged` - **уведомление об изменении статуса игрока**
    - **Инициатор:** Сервер (после получения toggleReady)
    - **Вызывается из:** server.js
    - **Передаваемые данные:** Объект с ID игрока и новым статусом готовности
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Все клиенты обновляют UI, показывая новый статус игрока

11. `allPlayersReady` - **уведомление о готовности всех игроков**
    - **Инициатор:** Сервер (когда все игроки в комнате получили статус "готов")
    - **Вызывается из:** server.js
    - **Передаваемые данные:** Объект с ID комнаты и временем до старта игры
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Все клиенты показывают обратный отсчет до начала игры
    - **UI-эффекты:** Скрывается кнопка "Назад", отображается таймер обратного отсчета

12. `countdownCancelled` - **отмена обратного отсчета**
    - **Инициатор:** Сервер (когда количество игроков стало меньше минимально необходимого)
    - **Вызывается из:** server.js
    - **Передаваемые данные:** Объект с причиной отмены, ID игрока, покинувшего комнату
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Клиенты останавливают таймер, показывают сообщение о причине отмены
    - **UI-эффекты:** Показывается кнопка "Назад", скрывается таймер

13. `startGame` - **начало игры**
    - **Инициатор:** Сервер (когда истечет время обратного отсчета)
    - **Вызывается из:** server.js
    - **Передаваемые данные:** Объект с ID комнаты и стартовыми параметрами игры
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Все клиенты переходят на страницу игры и начинается геймплей

### Управление игровым процессом

14. `playerPosition` - **обновление позиции игрока**
    - **Инициатор:** Клиент (во время игры, при изменении позиции)
    - **Вызывается из:** views/gameView.js
    - **Передаваемые данные:** Координаты игрока, скорость, угол наклона
    - **Обработчик:** server.js, server/game.js
    - **Ответ:** Событие `gameState` для всех игроков в комнате

15. `gameState` - **обновление состояния игры**
    - **Инициатор:** Сервер (периодически или после значимых изменений)
    - **Вызывается из:** server.js, server/game.js
    - **Передаваемые данные:** Объект с позициями всех игроков, препятствий, очками
    - **Обработчик:** views/gameView.js для всех клиентов в комнате
    - **Что происходит:** Клиенты обновляют отображение игры согласно новому состоянию

16. `playerCrashed` - **столкновение игрока с препятствием**
    - **Инициатор:** Клиент (при обнаружении столкновения)
    - **Вызывается из:** views/gameView.js
    - **Передаваемые данные:** ID игрока, позиция, причина столкновения
    - **Обработчик:** server.js, server/game.js
    - **Ответ:** Событие `playerOut` для всех игроков в комнате

17. `playerOut` - **уведомление о выбытии игрока из игры**
    - **Инициатор:** Сервер (после получения playerCrashed или при выходе игрока)
    - **Вызывается из:** server.js, server/game.js
    - **Передаваемые данные:** ID игрока, причина выбытия, оставшиеся игроки
    - **Обработчик:** views/gameView.js для всех клиентов в комнате
    - **Что происходит:** Клиенты отмечают игрока как выбывшего, обновляют UI

18. `gameResults` - **финальные результаты игры**
    - **Инициатор:** Сервер (когда игра завершена)
    - **Вызывается из:** server.js, server/game.js
    - **Передаваемые данные:** Список игроков с результатами, победитель
    - **Обработчик:** views/gameView.js для всех клиентов в комнате
    - **Что происходит:** Клиенты отображают экран с результатами, предлагают сыграть снова

### Обработка выхода игрока из комнаты

19. `leaveRoom` - **запрос на выход из комнаты**
    - **Инициатор:** Клиент (при нажатии кнопки "Назад", закрытии приложения)
    - **Вызывается из:** views/roomView.js, telegram.js
    - **Передаваемые данные:** ID комнаты и ID игрока
    - **Обработчик:** server.js, removePlayerFromRoom
    - **Что происходит:** Сервер удаляет игрока из комнаты и уведомляет остальных

20. `playerLeft` - **уведомление о выходе игрока**
    - **Инициатор:** Сервер (после успешного удаления игрока из комнаты)
    - **Вызывается из:** server.js, removePlayerFromRoom
    - **Передаваемые данные:** Объект с ID игрока, именем, обновленным списком игроков
    - **Обработчик:** views/roomView.js для всех клиентов в комнате
    - **Что происходит:** Клиенты обновляют UI, удаляя покинувшего игрока
    - **Особая логика:** Проверка количества оставшихся игроков для отмены отсчета

### Обработка ошибок и отключение

21. `roomError` - **ошибки, связанные с комнатами**
    - **Инициатор:** Сервер (при возникновении ошибок в операциях с комнатами)
    - **Вызывается из:** Различные обработчики в server.js
    - **Передаваемые данные:** Объект с сообщением об ошибке и кодом ошибки
    - **Обработчик:** views/mainMenu.js, views/roomView.js
    - **Что происходит:** Клиент отображает сообщение об ошибке и возможно перенаправляет пользователя

22. `error` - **общие ошибки**
    - **Инициатор:** Сервер (при возникновении других ошибок)
    - **Вызывается из:** Различные обработчики в server.js
    - **Передаваемые данные:** Объект с сообщением об ошибке
    - **Обработчик:** services/socketService.js, передается в компоненты через события
    - **Что происходит:** Клиент отображает сообщение об ошибке

23. `disconnect` - **отключение пользователя**
    - **Инициатор:** Socket.IO клиент (при закрытии страницы, потере соединения)
    - **Вызывается из:** Системное событие Socket.IO
    - **Обработчик:** server.js
    - **Что происходит:** Сервер обрабатывает выход игрока из комнаты, обновляет списки и уведомляет других игроков
    - **Особая логика:** Проверка, находился ли игрок в комнате, отмена отсчета при недостаточном количестве игроков

24. `reconnect` - **переподключение пользователя**
    - **Инициатор:** Socket.IO клиент (при восстановлении соединения)
    - **Вызывается из:** services/socketService.js
    - **Обработчик:** services/socketService.js и server.js
    - **Что происходит:** Клиент пытается восстановить предыдущее состояние, переавторизоваться и снова войти в комнату
    - **Передаваемые данные:** ID пользователя, ID комнаты, которую необходимо восстановить

25. `adminCommand` - **административное управление**
    - **Инициатор:** Клиент с правами админа
    - **Вызывается из:** Специальный интерфейс админа
    - **Передаваемые данные:** Команда и параметры
    - **Обработчик:** server.js (специальный обработчик админ-команд)
    - **Что происходит:** Выполнение административных действий на сервере (рестарт комнат, очистка данных и т.д.)

26. `updateSettings` - **обновление пользовательских настроек**
    - **Инициатор:** Клиент (при изменении настроек)
    - **Вызывается из:** views/mainMenu.js или специальный компонент настроек
    - **Передаваемые данные:** Объект с новыми настройками пользователя
    - **Обработчик:** server.js
    - **Что происходит:** Сохранение пользовательских настроек на сервере

## Механизмы обеспечения стабильности

### 1. Обработка отключений и восстановление соединения
- Автоматическое переподключение при потере связи через Socket.IO
- Сохранение состояния комнаты при отключении
- Специальный обработчик для выхода игрока во время обратного отсчета
- Обработка событий закрытия приложения Telegram

### 2. Корректная отмена обратного отсчета
- Проверка минимального количества игроков (не менее 2-х)
- Остановка таймера и уведомление всех игроков при отмене
- Восстановление интерфейса комнаты (показ кнопки "Назад")
- Информативные сообщения о причине отмены

### 3. Обработка ошибок и восстановление
- Клиентская сторона обрабатывает ошибки и выводит понятные для пользователя сообщения
- Сервер логирует ошибки и отправляет клиентам структурированные сообщения
- Реализована система восстановления соединения при разрыве связи
- Восстановление данных пользователя из localStorage при проблемах с Telegram API
- Обработка проблем с отображением UI (пересоздание элементов в DOM)

### 4. Механизмы синхронизации состояния
- Централизованное хранение состояния игровых комнат на сервере
- Правильная обработка добавления/удаления игроков
- Передача полного списка игроков при обновлениях
- Сохранение статусов готовности при обновлении списка
- Флаг `preserveStatuses` для сохранения состояний при изменении списка

## Интеграция с Telegram Mini Apps

### 1. Использование Telegram WebApp API
- Получение данных пользователя через initDataUnsafe
- Управление полноэкранным режимом через expand()
- Работа с кнопкой "Назад" через BackButton
- Обработка события "close" приложения
- Адаптация к изменениям размера экрана (viewport)

### 2. Обработка жизненного цикла приложения
- Корректный выход из комнаты при закрытии приложения
- Обработка изменений видимости приложения
- Восстановление состояния при возвращении в приложение
- Сохранение критичных данных в localStorage

### 3. Адаптация UI к Telegram
- Оптимизация интерфейса для мобильных устройств
- Использование нативных стилей Telegram
- Поддержка темной/светлой темы
- Правильное масштабирование на различных устройствах

## Развертывание
1. Проект запускается через Docker Compose
2. Файлы настраиваются через переменные окружения в .env
3. SSL-сертификаты получаются через certbot
4. Сервер поддерживает как HTTP, так и HTTPS подключения 
5. Настроено автоматическое обновление сертификатов

## Оптимизация и производительность
1. Минимизация количества WS-событий для снижения нагрузки
2. Оптимизация Canvas-рендеринга в игровом процессе
3. Использование дебаунсинга и тротлинга для частых событий
4. Предзагрузка игровых ресурсов для избежания задержек
5. Использование requestAnimationFrame для плавной анимации 