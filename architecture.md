# Архитектура проекта FlappyCoin

## Общее описание
FlappyCoin - это многопользовательская игра в стиле FlappyBird для Telegram Mini Apps с криптовалютной тематикой. Игроки управляют монетой, которая летит через трубы, соревнуясь друг с другом в реальном времени.

## Технический стек
- **Сервер**: Node.js, Express.js, Socket.IO
- **Клиент**: HTML, CSS, JavaScript, Canvas API
- **Коммуникация**: WebSocket через Socket.IO
- **Хранение данных**: JSON-файлы (telegramUsers.json)
- **Логирование**: Клиентское и серверное логирование
- **Контейнеризация**: Docker, Docker Compose
- **SSL**: Let's Encrypt через certbot

## Структура проекта
```
FlappyCoin/
├── client/                # Клиентская часть
│   ├── index.html         # Главная страница (меню)
│   ├── index.js           # Логика главного меню
│   ├── room.html          # Страница комнаты ожидания
│   ├── game.html          # Страница игры
│   ├── game.js            # Логика игры (Canvas, управление)
│   ├── logger.js          # Модуль клиентского логирования
│   ├── Style/             # CSS-стили
│   │   ├── mainMenu.css   # Стили главного меню
│   │   ├── room.css       # Стили страницы комнаты
│   │   └── game.css       # Стили игры
│   └── assets/            # Графические ресурсы
│       ├── bitcoin.png    # Спрайт монеты Bitcoin
│       └── default-avatar.png # Аватар по умолчанию
├── server/                # Серверная часть
│   ├── server.js          # Основной сервер (Express + Socket.IO)
│   ├── rooms.js           # Логика управления комнатами
│   └── telegramUsers.json # Хранение данных игроков
├── .env                   # Переменные окружения
├── Stack.md               # Стек технологий и логи изменений
├── Dockerfile             # Конфигурация контейнера
├── docker-compose.yml     # Конфигурация Docker Compose
└── package.json           # Зависимости и скрипты проекта
```

## Компоненты и их функции

### Клиентская часть

#### 1. Главное меню (index.html, index.js)
- Отображение данных пользователя из Telegram
- Анимированная монета в центре экрана
- Кнопки для создания и присоединения к комнате
- WebSocket-подключение для получения списка комнат
- Сохранение данных пользователя в localStorage для восстановления сессии

#### 2. Комната ожидания (room.html)
- Отображение списка игроков в комнате
- Индикация статуса готовности игроков
- Обратный отсчет перед началом игры
- WebSocket-обновления статусов игроков в реальном времени
- Обработка ошибок связанных с комнатой и пользователями

#### 3. Игра (game.html и game.js)
- Canvas-рендеринг игрового процесса
- Анимация монеты игрока и соперников
- Генерация препятствий (труб)
- Обработка столкновений
- Отправка и получение данных о позициях и счете через WebSocket
- Обработка ошибок и отключений игроков

#### 4. Модуль логирования (logger.js)
- Ведение клиентских логов различных уровней (info, debug, warn, error)
- Передача логов на сервер для централизованного хранения
- Отладка ошибок пользователей

### Серверная часть

#### 1. Основной сервер (server.js)
- Настройка Express и Socket.IO
- Обработка HTTP и WebSocket-запросов
- Статичная раздача клиентских файлов
- API для получения данных о комнатах и пользователях
- Обработка подключений и отключений пользователей
- Сохранение сессий пользователей

#### 2. Модуль управления комнатами (rooms.js)
- Управление жизненным циклом комнат
- Добавление/удаление игроков
- Управление статусами готовности
- Хранение данных о счете игроков
- Безопасные методы доступа к комнатам с проверками

### Взаимодействие компонентов
1. Клиент подключается через WebSocket, отправляет данные из Telegram
2. Сервер сохраняет данные пользователя в telegramUsers.json
3. Клиент может создать или присоединиться к комнате
4. При навигации между страницами сохраняется состояние комнаты и соединения
5. В комнате игроки отмечают готовность, запускается обратный отсчет
6. В игре клиенты обмениваются данными о позициях через WebSocket
7. При отключении игрока сервер обрабатывает его статус в зависимости от контекста

## WebSocket-события
В данном разделе описаны WebSocket-события в порядке их появления в процессе взаимодействия пользователя с приложением. Для каждого события указано, кто его инициирует, какой ожидается ответ и откуда происходит вызов.

### Авторизация и подключение

1. `connect` - **системное событие Socket.IO**
   - **Инициатор:** Socket.IO клиент
   - **Вызывается из:** client/index.js, client/room.html, client/game.js при создании соединения
   - **Обработчик:** На сервере в server.js
   - **Ответ:** Нет прямого ответа, но после подключения сервер готов принимать другие события

2. `join` - **авторизация пользователя**
   - **Инициатор:** Клиент (инициируется сразу после connect)
   - **Вызывается из:** client/index.js:118, client/room.html:149
   - **Передаваемые данные:** Объект с данными пользователя из Telegram
   - **Обработчик:** server.js:76
   - **Ответ:** События `joined` или `error`

3. `joined` - **подтверждение авторизации**
   - **Инициатор:** Сервер (как ответ на join)
   - **Вызывается из:** server.js:99
   - **Передаваемые данные:** Объект с данными пользователя и статусом успеха
   - **Обработчик:** client/index.js:126, client/room.html:152
   - **Что происходит:** Клиент подтверждает авторизацию, сохраняет данные пользователя

### Управление комнатами

4. `createRoom` - **создание комнаты**
   - **Инициатор:** Клиент (при нажатии на кнопку "Создать комнату")
   - **Вызывается из:** client/index.js:190
   - **Передаваемые данные:** Нет (используются данные авторизованного пользователя)
   - **Обработчик:** server.js:107
   - **Ответ:** События `roomCreated` или `roomError`

5. `roomCreated` - **уведомление о создании комнаты**
   - **Инициатор:** Сервер (как ответ на createRoom)
   - **Вызывается из:** server.js:143
   - **Передаваемые данные:** Объект с ID созданной комнаты
   - **Обработчик:** client/index.js:143
   - **Что происходит:** Клиент сохраняет ID комнаты и перенаправляется на страницу комнаты

6. `roomsUpdated` - **обновление списка комнат**
   - **Инициатор:** Сервер (после создания/удаления комнаты)
   - **Вызывается из:** server.js:146, server.js:335
   - **Передаваемые данные:** Объект со всеми активными комнатами
   - **Обработчик:** client/index.js:136
   - **Что происходит:** Клиент обновляет список доступных комнат

7. `joinRoom` - **присоединение к комнате**
   - **Инициатор:** Клиент (при нажатии на "Присоединиться" или переходе в комнату)
   - **Вызывается из:** client/index.js:281, client/room.html:155
   - **Передаваемые данные:** ID комнаты
   - **Обработчик:** server.js:167
   - **Ответ:** События `roomUpdated` или `roomError`

8. `roomUpdated` - **обновление данных комнаты**
   - **Инициатор:** Сервер (как ответ на joinRoom или при изменениях в комнате)
   - **Вызывается из:** server.js:202, server.js:205
   - **Передаваемые данные:** Объект с данными комнаты
   - **Обработчик:** client/room.html:160
   - **Что происходит:** Клиент обновляет интерфейс комнаты, отображая игроков и их статусы

### Игровой процесс

9. `ready` - **готовность игрока**
   - **Инициатор:** Клиент (при нажатии на кнопку "Я готов!")
   - **Вызывается из:** client/room.html:252
   - **Передаваемые данные:** ID комнаты
   - **Обработчик:** server.js:225
   - **Ответ:** Обновление `roomUpdated` для всех игроков в комнате

10. `countdown` - **обратный отсчет**
    - **Инициатор:** Сервер (когда все игроки готовы)
    - **Вызывается из:** server.js:247
    - **Передаваемые данные:** Число секунд до начала игры
    - **Обработчик:** client/room.html:165
    - **Что происходит:** Клиент отображает таймер обратного отсчета

11. `gameStart` - **начало игры**
    - **Инициатор:** Сервер (когда countdown достигает 0)
    - **Вызывается из:** server.js:250
    - **Передаваемые данные:** Объект с данными комнаты
    - **Обработчик:** client/room.html:171
    - **Что происходит:** Клиент перенаправляется на страницу игры

12. `updatePosition` - **обновление позиции игрока**
    - **Инициатор:** Клиент (во время игры при движении)
    - **Вызывается из:** client/game.js (в процессе игры)
    - **Передаваемые данные:** Объект с ID комнаты и позицией игрока
    - **Обработчик:** server.js:267
    - **Ответ:** Сервер транслирует событие `playerMoved` другим игрокам

13. `playerMoved` - **движение других игроков**
    - **Инициатор:** Сервер (при получении updatePosition)
    - **Вызывается из:** server.js:271
    - **Передаваемые данные:** Объект с ID игрока и его позицией
    - **Обработчик:** client/game.js
    - **Что происходит:** Клиент обновляет позиции других игроков на экране

14. `updateScore` - **обновление счета игрока**
    - **Инициатор:** Клиент (при прохождении препятствия)
    - **Вызывается из:** client/game.js
    - **Передаваемые данные:** Объект с ID комнаты и новым счетом
    - **Обработчик:** server.js:279
    - **Ответ:** Сервер транслирует событие `scoreUpdated` всем игрокам

15. `scoreUpdated` - **обновление счета для всех игроков**
    - **Инициатор:** Сервер (при получении updateScore)
    - **Вызывается из:** server.js:289
    - **Передаваемые данные:** Объект с ID игрока, его счетом и обновленными данными комнаты
    - **Обработчик:** client/game.js
    - **Что происходит:** Клиент обновляет счет на экране для всех игроков

### Обработка ошибок и отключение

16. `roomError` - **ошибки, связанные с комнатами**
    - **Инициатор:** Сервер (при возникновении ошибок в операциях с комнатами)
    - **Вызывается из:** server.js:150, server.js:211
    - **Передаваемые данные:** Объект с сообщением об ошибке
    - **Обработчик:** client/index.js:160, client/room.html:181
    - **Что происходит:** Клиент отображает сообщение об ошибке и возможно перенаправляет пользователя

17. `error` - **общие ошибки**
    - **Инициатор:** Сервер (при возникновении других ошибок)
    - **Вызывается из:** server.js:88, server.js:258
    - **Передаваемые данные:** Объект с сообщением об ошибке
    - **Обработчик:** client/index.js:154, client/room.html:173
    - **Что происходит:** Клиент отображает сообщение об ошибке

18. `disconnect` - **отключение пользователя**
    - **Инициатор:** Socket.IO клиент (при закрытии страницы, потере соединения)
    - **Вызывается из:** Системное событие Socket.IO
    - **Обработчик:** server.js:302
    - **Что происходит:** Сервер обрабатывает выход игрока из комнаты, обновляет списки и уведомляет других игроков

## Обработка ошибок
1. Клиентская сторона обрабатывает ошибки и выводит понятные для пользователя сообщения
2. Сервер логирует ошибки и отправляет клиентам структурированные сообщения
3. Реализована система восстановления соединения при разрыве связи
4. Восстановление данных пользователя из localStorage при проблемах с Telegram API

## Переход между страницами
1. Приложение состоит из трех основных страниц: главное меню, комната ожидания и игра
2. При переходе между страницами используется localStorage для сохранения данных
3. Реализована логика для предотвращения потери комнаты при переходе между страницами
4. При отключении пользователя сервер учитывает контекст и дает время на переподключение

## Развертывание
1. Проект запускается через Docker Compose
2. Файлы настраиваются через переменные окружения в .env
3. SSL-сертификаты получаются через certbot
4. Сервер поддерживает как HTTP, так и HTTPS подключения 