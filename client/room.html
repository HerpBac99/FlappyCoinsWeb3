<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комната FlappyCoin</title>
    <link rel="stylesheet" href="Style/room.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Шапка комнаты -->
    <div class="room-header">
        <div id="room-id" class="room-id">Загрузка комнаты...</div>
        <button id="back-button" class="back-button">Назад</button>
    </div>

    <!-- Основной контейнер -->
    <div class="room-container">
        <!-- Информация о комнате -->
        <div class="room-info">
            <h2 class="room-title">Комната ожидания</h2>
            <p>Ожидание игроков. Когда все будут готовы, игра начнется автоматически.</p>
            
            <!-- Список игроков -->
            <div id="players-list" class="players-list">
                <!-- Игроки будут добавлены динамически -->
            </div>
        </div>
        
        <!-- Кнопка готовности -->
        <button id="ready-button" class="ready-button">Я готов!</button>
        
        <!-- Таймер обратного отсчета -->
        <div id="countdown" class="countdown">3</div>
    </div>

    <!-- Подключение Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Подключение основного скрипта -->
    <script>
        // Проверяем, запущено ли приложение в Telegram Web App
        const tgApp = window.Telegram?.WebApp;
        let userData = null;
        let socket = null;
        let roomId = null;
        let isPlayerReady = false;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', () => {
            // Получаем ID комнаты из URL
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('id');
            
            if (!roomId) {
                alert('ID комнаты не указан');
                window.location.href = '/';
                return;
            }
            
            // Обновляем ID комнаты в шапке
            document.getElementById('room-id').textContent = `Комната #${roomId}`;
            
            // Инициализация Telegram Mini App
            if (tgApp) {
                // Разворачиваем приложение на весь экран
                tgApp.expand();
                
                // Получаем данные пользователя из Telegram
                if (tgApp.initDataUnsafe && tgApp.initDataUnsafe.user) {
                    userData = {
                        id: tgApp.initDataUnsafe.user.id,
                        username: tgApp.initDataUnsafe.user.username || `User${tgApp.initDataUnsafe.user.id}`,
                        first_name: tgApp.initDataUnsafe.user.first_name,
                        last_name: tgApp.initDataUnsafe.user.last_name,
                        photo_url: tgApp.initDataUnsafe.user.photo_url
                    };
                }
            } else {
                // Для тестирования локально, создаем тестового пользователя
                userData = {
                    id: "12345",
                    username: "TestUser",
                    first_name: "Test",
                    last_name: "User",
                    photo_url: null
                };
                
                console.warn('Приложение запущено вне Telegram Mini App');
            }
            
            // Инициализация WebSocket соединения
            initializeSocket();
            
            // Настраиваем обработчики событий
            setupEventListeners();
        });

        // Инициализация WebSocket соединения
        function initializeSocket() {
            // Подключаемся к серверу
            socket = io();
            
            // Обработка успешного подключения
            socket.on('connect', () => {
                console.log('Подключено к серверу');
                
                // Отправляем данные пользователя на сервер
                if (userData) {
                    socket.emit('join', userData);
                    
                    // После авторизации присоединяемся к комнате
                    socket.on('joined', () => {
                        // Присоединяемся к комнате
                        socket.emit('joinRoom', roomId);
                    });
                }
            });
            
            // Обработка обновления информации о комнате
            socket.on('roomUpdated', (roomData) => {
                updateRoomInterface(roomData);
            });
            
            // Обработка обратного отсчета
            socket.on('countdown', (count) => {
                showCountdown(count);
            });
            
            // Обработка начала игры
            socket.on('gameStart', (roomData) => {
                console.log('Игра началась!', roomData);
                // Перенаправляем на страницу с игрой
                window.location.href = `/game.html?room=${roomId}`;
            });
            
            // Обработка ошибок
            socket.on('error', (error) => {
                console.error('Ошибка:', error.message);
                alert(`Ошибка: ${error.message}`);
                
                // При серьезной ошибке возвращаемся на главную
                if (error.message.includes('Комната не найдена') || 
                    error.message.includes('Вы уже присоединились')) {
                    window.location.href = '/';
                }
            });
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Кнопка "Назад"
            document.getElementById('back-button').addEventListener('click', () => {
                window.location.href = '/';
            });
            
            // Кнопка "Готов"
            document.getElementById('ready-button').addEventListener('click', () => {
                if (socket && socket.connected) {
                    // Отправляем событие готовности
                    socket.emit('ready', roomId);
                    
                    // Обновляем состояние кнопки
                    const readyBtn = document.getElementById('ready-button');
                    readyBtn.textContent = 'Готов!';
                    readyBtn.classList.add('ready');
                    readyBtn.disabled = true;
                    
                    // Обновляем статус игрока
                    isPlayerReady = true;
                }
            });
        }

        // Обновление интерфейса комнаты
        function updateRoomInterface(roomData) {
            if (!roomData) return;
            
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            
            // Добавляем каждого игрока в список
            roomData.players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                
                // Проверяем, текущий ли это игрок
                const isCurrentPlayer = player.id === userData.id;
                if (isCurrentPlayer) {
                    playerItem.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
                    
                    // Обновляем состояние кнопки, если игрок уже готов
                    if (player.ready) {
                        const readyBtn = document.getElementById('ready-button');
                        readyBtn.textContent = 'Готов!';
                        readyBtn.classList.add('ready');
                        readyBtn.disabled = true;
                        isPlayerReady = true;
                    }
                }
                
                // Создаем HTML для игрока
                playerItem.innerHTML = `
                    <div class="player-photo">
                        <img src="${player.photoUrl || 'assets/default-avatar.png'}" alt="Аватар">
                    </div>
                    <div class="player-details">
                        <div>
                            <span class="player-name">${player.username}</span>
                            ${player.isCreator ? '<span class="player-creator">Создатель</span>' : ''}
                        </div>
                        <div class="player-status ${player.ready ? 'status-ready' : 'status-not-ready'}">
                            ${player.ready ? 'Готов' : 'Не готов'}
                        </div>
                    </div>
                `;
                
                // Добавляем игрока в список
                playersList.appendChild(playerItem);
            });
            
            // Если игра в режиме обратного отсчета, скрываем кнопку готовности
            if (roomData.status === 'countdown') {
                document.getElementById('ready-button').style.display = 'none';
            }
        }

        // Показать таймер обратного отсчета
        function showCountdown(count) {
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = count;
            countdownElement.style.display = 'block';
            
            // Скрываем кнопку готовности
            document.getElementById('ready-button').style.display = 'none';
        }
    </script>
</body>
</html> 